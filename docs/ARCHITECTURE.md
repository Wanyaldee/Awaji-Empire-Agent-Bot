# ⚙️ Awaji Empire Agent Bot - 詳細設計と運用ドキュメント

## 1. システム全体設計（データフロー）

本 Bot は、 **「設定分離」「共通関数化」「機能のモジュール化（コグ）」** の3原則に基づいて設計されています。

| 要素 | 役割 | 連携先 | 備考 |
| :--- | :--- | :--- | :--- |
| **`config.py`** | チャンネルID、管理者IDなどの設定値定義。 | 全てのファイル。 | コードの再利用性と保守性を担保。 |
| **`bot.py` (Core)** | Discord接続、インテント管理、コグのロード。 | Discord API, 全てのコグ。 | コグが安全に利用できる `send_admin_dm` を提供。 |
| **`cogs/filter.py`** | メッセージ受信（`on_message`）フック。 | Discord API, `bot.py` (DM送信)。 | 不正投稿を検知し、即時削除とログ送信を実行。 |
| **`cogs/mass_mute.py`** | チャンネル作成フック、定時タスク。 | Discord API, `bot.py` (DM送信)。 | チャンネル権限（`@everyone`）を操作し、通知ミュートを適用。 |

## 2. コア機能の詳細設計
  
### 2.0. 今後の機能拡張に関する設計方針

Botの安定性と保守性を維持するため、以下の設計方針を遵守します。

| 方針 | 詳細 | 目的 |
| :--- | :--- | :--- |
| **全機能のコグ化** | 全ての新しい機能（例：チャットボット、定期レポート、投票機能など）は、必ず**新しいコグ (`cogs/new_feature.py`) として実装**し、Botコア (`bot.py`) から分離する。 | 機能ごとの独立性を高め、特定のエラーが Bot 全体のクラッシュを引き起こすのを防ぐ。 |
| **最小限の権限** | 新しいコグが要求する Discord の権限（インテント、ロール権限）は、その機能の実行に**最小限必要なものに限定**する。 | セキュリティリスクの低減。 |
| **設定の一元化** | 新しい機能に必要な設定値（チャンネルID、タイマー間隔など）は、すべて `config.py` に追記し、コード内にハードコーディングしない。 | 運用変更時のメンテナンスの容易性。 |
| **Docstringの記述** | 新しいコグ、クラス、重要なメソッドには、必ず**機能概要と動作ロジックを説明したDocstringを日本語で記述**する。 | ドキュメント自動生成 (`doc_generator.py`) が正確に機能情報を抽出できるようにする。 |

### 2.1. コグ間共通関数 (`bot.py` 内)

全てのコグが Bot の稼働状況やエラーを管理者に通知するために、以下の共通関数をコアで定義しています。

#### `async def send_admin_dm(bot, title, description, color)`

* **目的**: 管理者 (`config.ADMIN_USER_ID`) へログメッセージ（Embed形式）を送信。
* **処理**: `bot.fetch_user()` を使用してユーザーオブジェクトを取得し、DMを送信。

### 2.2. フィルタリング (`cogs/filter.py`)

#### 2.2.1. 監視ロジック

| 処理 | 詳細 |
| :--- | :--- |
| **トリガー** | `on_message` イベント。 |
| **除外条件** | 1. Bot自身のメッセージ。 2. `config.CODE_CHANNEL_ID` **ではない**チャンネルからのメッセージ。 3. `CODE_PATTERN` (8桁の英数字) に**完全に一致する**メッセージ。 |
| **アクション** | 除外条件に当てはまらない場合、`message.delete()` を実行し、`send_admin_dm` で削除ログを送信。 |

![エアライダーオレマシン置き場のロジック](./assets/filter_operation.png)

#### 2.2.2. エラー耐性

* `try...except discord.Forbidden`: Botにメッセージ削除権限がない場合でも、クラッシュを防ぎ、その旨を管理者にDMで通知します。

### 2.3. 通知マスミュート (`cogs/mass_mute.py`)

![通知マスミュートのロジック](./assets/mass-mute_operation.png)

#### 2.3.1. 権限適用ロジック (`_apply_notification_mute_to_channel`)

* **適用対象**: チャンネルの `@everyone` ロール。
* **設定内容**: `overwrite.send_messages = False` （メッセージ送信を拒否）を設定し、通知ミュートを実現します。
* **DM通知**: **権限設定が実際に変更された場合のみ** (`return True` の場合)、`send_admin_dm` で成功ログを送信します。

#### 2.3.2. タスクとスケジューリング

| タスク | トリガー | 目的 |
| :--- | :--- | :--- |
| **`on_guild_channel_create`** | チャンネル作成イベント。 | `MUTE_CHANNEL_NAMES` に一致するチャンネルが作成された際、Botがすぐにミュートを適用し、ミュート適用漏れを防ぎます。 |
| **`daily_mute_check`** | 毎日 **16:00 JST**。 | 定期的に全ての対象チャンネルを巡回し、設定が何らかの理由で変更されていないかを確認し、再適用します。 |


## 3. 運用・デバッグ履歴（教訓）

### 3.1. ログの確認とエラーの種類

Botのログ（`systemd`）は、**標準出力（`print`）**と**標準エラー（例外）**の両方を含みます。

| エラー/現象 | 確認ログ | 意味 | 解決策 |
| :--- | :--- | :--- | :--- |
| **致命的クラッシュ** | `PrivilegedIntentsRequired` | **コードは正しい**が、Discordウェブサイトの権限設定が不足。 | Discord Developer Portalで3つのインテントを有効化。 |
| **機能不動作** | `TabError` や `SyntaxError` | **コードに不正なインデントまたは文字**が残存。 | `nano`などでファイルを開き、インデントをスペースに統一（今回は `mass_mute.py` で発生）。 |
| **定時タスク実行** | `🔔 定時ミュートチェックを開始` | タスクがスケジュール通りに起動したことを示します。 | DMが届かない場合は、まずこのログを確認する。 |

### 3.2. メンテナンストリビア

* **時刻管理**: `mass_mute.py` の定時タスクは、`datetime.time(tzinfo=JST)` を使用し、日本時間（JST, UTC+9）で正確に実行されるように設計されています。
* **トークンの扱い**: トークンは `token.txt` に保存され、`.gitignore` で厳重に管理されているため、GitHubへのプッシュ時も安全です。

## 4. 実行環境とデプロイメント

本 Bot は、Linux VM上に構築された専用環境で稼働しています。

### 4.1. 環境概要図

Botの実行環境、権限、および外部サービス（Discord API, GitHub, systemd）との連携を示す全体図です。

![実行環境の全体図](./assets/runtime_architecture.png)

### 4.2. デプロイメント構成

| 項目 | 詳細 | 備考 |
| :--- | :--- | :--- |
| **プラットフォーム** | Linux VM (Ubuntu/Debian系) | サーバーOSとして採用。 |
| **Python環境** | 仮想環境 (`venv`) | ホストOSの環境から分離し、依存関係を独立して管理。 |
| **永続化** | `systemd` サービス | サーバー起動時自動実行、クラッシュ時の自動再起動 (Restart=always) を設定済み。サービス名は `discord-awaji-empire-agent-bot.service`。 |
| **設定/秘密情報** | `config.py` / `token.txt` | 設定値とトークンを分離し、トークンは Git 管理から除外（`.gitignore`）。 |
| **外部依存** | Discord Developer Portal | **Presence/Members/Message Content Intent**の有効化が必須。 |

### 4.3. 運用・ログ管理

* **ログ確認**: `journalctl` により、サービスログ、コグのロード状況、タスク実行ログを確認します。
    ```bash
    sudo journalctl -u discord-awaji-empire-agent-bot.service -f
    ```
* **Git連携**: VM上で直接 Git を操作し、GitHubリポジトリとコード・ドキュメントを同期します。

### 4.4. ハードウェアおよび仮想化環境の詳細

本 Bot の実行環境は、物理サーバー上に構築された仮想化プラットフォーム上で稼働しています。

#### 4.4.1. 仮想化プラットフォーム

Botは以下の2層構造の仮想化環境で稼働しています。

| 階層 | ソフトウェア/OS | 役割 |
| :--- | :--- | :--- |
| **物理ホストOS (Hypervisor)** | Proxmox VE 9.1 | 物理サーバー上で稼働し、仮想マシンを管理。高可用性（HA）とリソース管理を担当。 |
| **ゲストOS (VM)** | Ubuntu 24.04 LTS | Botの実行環境。Python、`discord.py`、`systemd` サービスがこのOS上で動作。 |

#### 4.4.2. 物理サーバー構成（自作PC）

Botが稼働する物理サーバーのハードウェア仕様は以下の通りです。

| 項目 | 詳細 | 備考 |
| :--- | :--- | :--- |
| **CPU** | Intel Core i3 9100F | 仮想マシンへリソースを割り当て。 |
| **RAM** | DDR4 16GB | 物理メモリ容量。ゲストOSへのメモリ割り当て上限の基準。 |
| **マザーボード** | Asrock H310CM-HDV/M.2 | |
| **ストレージ** | SSD 500GB | Proxmox VEのインストールと、ゲストOSのディスク領域として使用。 |

#### 4.4.3. 仮想マシン（Bot実行環境）へのリソース割り当て

物理リソースから Bot の実行環境であるゲストOSへ割り当てられているリソースは以下の通りです。このリソースは Proxmox VE の管理画面で確認されています。

| 項目 | 割り当て値 |
| :--- | :--- |
| **CPUコア数** | 1 CPU(s) |
| **メモリ** | 4.00 GiB (約 4GB) |
| **ブートディスク** | 32.00 GiB |
