# ⚙️ Awaji Empire Agent Bot - 詳細設計と運用ドキュメント
## 1. システム全体設計（データフロー）

本 Bot は、 **「設定分離」「共通関数化」「機能のモジュール化（コグ）」** の3原則に基づいて設計されています。

| 要素 | 役割 | 連携先 | 備考 |
| :--- | :--- | :--- | :--- |
| **`config.py`** | チャンネルID、管理者IDなどの設定値定義。 | 全てのファイル。 | コードの再利用性と保守性を担保。 |
| **`bot.py` (Core)** | Discord接続、インテント管理、コグのロード。 | Discord API, 全てのコグ。 | コグが安全に利用できる `send_admin_dm` を提供。 |
| **`cogs/filter.py`** | メッセージ受信（`on_message`）フック。 | Discord API, `bot.py` (DM送信)。 | 不正投稿を検知し、即時削除とログ送信を実行。 |
| **`cogs/mass_mute.py`** | チャンネル作成フック、定時タスク。 | Discord API, `bot.py` (DM送信)。 | チャンネル権限（`@everyone`）を操作し、通知ミュートを適用。 |

### 1.2 設定ファイルの設計 (`config.py`)

Botの設定値は全て `config.py` に記述し、メインコードからインポートされます。セキュリティ向上のため、Botトークンは別途 `token.txt` ファイルで管理されます。

**[重要な変更点]** Discord ID（ユーザーID、チャンネルID）は全て**文字列 (`str`)** として定義されます。

| 設定名 | 形式 | 用途 |
| :--- | :--- | :--- |
| `ADMIN_USER_ID` | `str` | Botの起動ログやエラー通知の送信先となる管理者 ID。 |
| `CODE_CHANNEL_ID` | `str` | フィルタリング機能の対象となるチャンネル ID。 |
| `MUTE_ONLY_CHANNEL_NAMES` | `List[str]` | 通知抑制を行う対象チャンネル名のリスト（送信権限は既存設定を尊重）。 |
| `READ_ONLY_MUTE_CHANNEL_NAMES` | `List[str]` | ログ系チャンネル名のリスト（送信権限は既存設定を尊重）。 |

## 2. コア機能の詳細設計

### 2.0. 今後の機能拡張に関する設計方針

Botの安定性と保守性を維持するため、以下の設計方針を遵守します。

| 方針 | 詳細 | 目的 |
| :--- | :--- | :--- |
| **全機能のコグ化** | 全ての新しい機能（例：チャットボット、定期レポート、投票機能など）は、必ず**新しいコグ (`cogs/new_feature.py`) として実装**し、Botコア (`bot.py`) から分離する。 | 機能ごとの独立性を高め、特定のエラーが Bot 全体のクラッシュを引き起こすのを防ぐ。 |
| **最小限の権限** | 新しいコグが要求する Discord の権限（インテント、ロール権限）は、その機能の実行に**最小限必要なものに限定**する。 | セキュリティリスクの低減。 |
| **設定の一元化** | 新しい機能に必要な設定値（チャンネルID、タイマー間隔など）は、すべて `config.py` に追記し、コード内にハードコーディングしない。 | 運用変更時のメンテナンスの容易性。 |
| **Docstringの記述** | 新しいコグ、クラス、重要なメソッドには、必ず**機能概要と動作ロジックを説明したDocstringを日本語で記述**する。 | ~~ ドキュメント自動生成 (`doc_generator.py`) が正確に機能情報を抽出できるようにする。 ~~ |

### 2.1. コグ間共通関数 (`bot.py` 内)

全てのコグが Bot の稼働状況やエラーを管理者に通知するために、以下の共通関数をコアで定義しています。

##### `async def send_admin_dm(bot, title, description, color)`

* **目的**: 管理者 (`config.ADMIN_USER_ID`) へログメッセージ（Embed形式）を送信。
* **処理**: `bot.fetch_user()` を使用してユーザーオブジェクトを取得し、DMを送信。

#### 2.1.1 起動シーケンス (Startup Sequence)

Botの起動は、再接続時のエラーを防止し、堅牢性を高めるために以下の順序で実行されます。

1.  **クラス初期化**: `commands.Bot` を継承した `MyBot` クラスがインスタンス化されます。
2.  **setup_hook (一度限りの実行)**: 
    * Discord への接続前に実行されます。
    * 全てのコグ (`cogs.filter`, `cogs.mass_mute`) をロードします。
    * これにより、ネットワーク瞬断による再接続（Resume）が発生しても、コグの二重ロードエラーが発生しません。
3.  **on_ready (接続/再接続のたびに実行)**:
    * 管理者へのオンライン通知 DM を送信します。
    * `MassMuteCog` の実行ロジックを非同期タスクとしてトリガーし、サーバーの権限状態を最新（定義通り）の状態にリセットします。

### 2.2. フィルタリング (`cogs/filter.py`)

#### 2.2.1. 監視ロジック

| 処理 | 詳細 |
| :--- | :--- |
| **トリガー** | `on_message` イベント。 |
| **除外条件** | 1. Bot自身のメッセージ。 2. `config.CODE_CHANNEL_ID` **ではない**チャンネルからのメッセージ。 3. `CODE_PATTERN` (8桁の英数字) に**完全に一致する**メッセージ。 |
| **アクション** | 除外条件に当てはまらない場合、`message.delete()` を実行し、`send_admin_dm` で削除ログを送信。 |

![エアライダーオレマシン置き場のロジック](./assets/filter_operation.png)

#### 2.2.2. エラー耐性

* `try...except discord.Forbidden`: Botにメッセージ削除権限がない場合でも、クラッシュを防ぎ、その旨を管理者にDMで通知します。

#### 2.2.3 必要なDiscord権限 (コードチャンネル フィルタ)

コードチャンネルフィルタが正常に機能するためには、Botに割り当てられたロールが、対象チャンネルに対して以下の権限を持っている必要があります。

| 権限 | 適用範囲 | 理由 |
| :--- | :--- | :--- |
| **メッセージの管理** | フィルタリング対象のチャンネル | 添付ファイルがないメッセージをBotが自動で**削除**するために必要です。 |

### 2.3 通知マスミュート (`cogs/mass_mute.py`)

この機能は、指定されたチャンネルの通知設定を ** `@everyone` ロールに対して強制的に上書き**することで、サーバー全体の通知を抑制します。この処理は、Bot 起動時や毎日指定された固定時刻に実行されます。

#### 2.3.1 処理の流れ (Data Flow)

通知マスミュートの処理ロジックは以下の図の通りです。
![通知マスミュートのロジック](./assets/mass-mute_operation.png)

1.  **トリガー (Trigger)**:
    * **Startup**: Bot 起動完了後、`bot.py` の `on_ready` から `MassMuteCog.execute_mute_logic` を**直接**呼び出し、即座に実行されます。（コグの `on_ready` との競合を回避するため）
    * **Daily Task**: `discord.ext.tasks` により、毎日指定された固定時刻（UTC 0:00, 8:00, 16:00）に自動実行されます。
2.  **チャンネル探索**: `MUTE_ONLY_CHANNEL_NAMES` と `READ_ONLY_MUTE_CHANNEL_NAMES` の両リストに基づき、対象チャンネルを名前で探索します。
3.  **権限上書き**:
    * 探索された各チャンネルに対し、`@everyone` ロールの権限を **`MUTE_OVERWRITE`**（`mention_everyone=False`, `manage_webhooks=False` のみ）で上書きします。
    * これにより、**通知機能のみが抑制**され、メッセージ送信権限は既存の設定に保たれます。
4.  **ログ/通知**:
    * 成功・失敗にかかわらず、詳細なログとエラー通知 DM を管理者へ送信します。

#### 2.3.2 使用される設定値 (Config)

この機能は、以下の設定値に依存します。

| 設定名 | ファイル | 形式 | 用途 |
| :--- | :--- | :--- | :--- |
| `ADMIN_USER_ID` | `config.py` | `str` | 処理結果やエラー通知 DM の送信先となる管理者 ID。 |
| `MUTE_ONLY_CHANNEL_NAMES` | `List[str]` | 通知抑制を行うチャンネル名のリスト（メッセージ送信可）。 |
| `READ_ONLY_MUTE_CHANNEL_NAMES` | `List[str]` | ログチャンネル名のリスト（メッセージ送信不可を期待）。 |

#### 2.3.3 必要なDiscord権限

常時通知抑制機能が正常に機能するためには、Botに割り当てられたロールが、対象チャンネルに対して以下の権限を持っている必要があります。

| 権限 | 適用範囲 | 理由 |
| :--- | :--- | :--- |
| **権限の管理** | サーバー全体 または 対象チャンネル | `@everyone` ロールのチャンネル権限設定をBotが**上書き変更**するために必須です。 |

> [!NOTE]
> チャンネル個別の権限設定は、チャンネル削除時に消失するため不要です。サーバー全体のロール設定で「ロールの管理」を有効にしてください。

#### 2.3.4 権限上書きのポリシー (Permission Policy)

単なる通知抑制だけでなく、チャンネルの用途に応じてメッセージ送信権限を**明示的に固定**します。これにより、意図しない権限の緩みを防ぎます。

| チャンネルグループ | 対象例 | メッセージ送信 | 通知 (メンション/Webhook) |
| :--- | :--- | :--- | :--- |
| **MUTE_ONLY** | 配信コメント, メイン | **許可 (True)** | 抑制 (False) |
| **READ_ONLY_MUTE** | 参加ログ, システムログ | **禁止 (False)** | 抑制 (False) |

#### 2.3.5 実行タイミング

通知抑制の設定は、以下の 3 つのイベントをトリガーとして実行・維持されます。

1.  **Startup/Reconnected**: Bot 起動時および再接続時。既存の全対象チャンネルの設定をリフレッシュします。
2.  **Daily Task**: 毎日指定時刻。運用中に手動で設定が変更された場合でも、定義通りの状態に強制的に塗り直します。
3.  **Dynamic Recovery (on_guild_channel_create)**: 
    * 🚨 **重要**: 運用上、チャンネルが削除・再作成されたことを検知すると、Bot はサーバー全体の「ロールの管理」権限を用いて、新しく作成されたチャンネルの `@everyone` 権限を即座に再設定します。
    * これにより、配信コメントリセット等の運用があっても、通知抑制状態が自動的に復元されます。

#### 2.3.6 通知制御の限界と推奨設定 (Limitations & Recommendations)

Botによる権限制御は「通知のきっかけ（メンション等）」を最小化しますが、Discordの仕様上、以下の点に注意が必要です。

1. **ユーザー個人設定の優先**: 
   各ユーザーがDiscordクライアントで「すべてのメッセージを通知」に設定している場合、Bot側でプッシュ通知を強制停止することはできません（セキュリティ上の制限）。
2. **推奨されるサーバー設定**: 
   本Botの機能を最大限に活かすため、サーバー管理者は「サーバー設定 > 通知設定」を **「@メンションのみ」** に設定することを強く推奨します。
3. **高権限ロールの考慮**: 
   Botは `@everyone` に対して制限をかけますが、特定のロールに対して個別に「メンション許可」が与えられている場合は、そちらが優先されます。

## 3. 運用・デバッグ履歴（教訓）

### 3.1. ログの確認とエラーの種類

Botのログ（`systemd`）は、**標準出力（`print`）**と**標準エラー（例外）**の両方を含みます。

| エラー/現象 | 確認ログ | 意味 | 解決策 |
| :--- | :--- | :--- | :--- |
| **致命的クラッシュ** | `PrivilegedIntentsRequired` | **コードは正しい**が、Discordウェブサイトの権限設定が不足。 | Discord Developer Portalで3つのインテントを有効化。 |
| **機能不動作** | `TabError` や `SyntaxError` | **コードに不正なインデントまたは文字**が残存。 | `nano`などでファイルを開き、インデントをスペースに統一（今回は `mass_mute.py` で発生）。 |
| **定時タスク実行** | `🔔 定時ミュートチェックを開始` | タスクがスケジュール通りに起動したことを示します。 | DMが届かない場合は、まずこのログを確認する。 |

### 3.2. メンテナンストリビア

* **時刻管理**: `mass_mute.py` の定時タスクは、`datetime.time(tzinfo=JST)` を使用し、日本時間（JST, UTC+9）で正確に実行されるように設計されています。
* **トークンの扱い**: トークンは `token.txt` に保存され、`.gitignore` で厳重に管理されているため、GitHubへのプッシュ時も安全です。

## 4. 実行環境とデプロイメント

本 Bot は、Linux VM上に構築された専用環境で稼働しています。

### 4.1. 環境概要図

Botの実行環境、権限、および外部サービス（Discord API, GitHub, systemd）との連携を示す全体図です。

![実行環境の全体図](./assets/runtime_architecture.png)

### 4.2. デプロイメント構成

| 項目 | 詳細 | 備考 |
| :--- | :--- | :--- |
| **プラットフォーム** | Linux VM (Ubuntu/Debian系) | サーバーOSとして採用。 |
| **Python環境** | 仮想環境 (`venv`) | ホストOSの環境から分離し、依存関係を独立して管理。 |
| **永続化** | `systemd` サービス | サーバー起動時自動実行、クラッシュ時の自動再起動 (Restart=always) を設定済み。サービス名は `discord-awaji-empire-agent-bot.service`。 |
| **設定/秘密情報** | `config.py` / `token.txt` | 設定値とトークンを分離し、トークンは Git 管理から除外（`.gitignore`）。 |
| **外部依存** | Discord Developer Portal | **Presence/Members/Message Content Intent**の有効化が必須。 |

### 4.3. 運用・ログ管理

* **ログ確認**: `journalctl` により、サービスログ、コグのロード状況、タスク実行ログを確認します。
    ```bash
    sudo journalctl -u discord-awaji-empire-agent-bot.service -f
    ```
* **Git連携**: VM上で直接 Git を操作し、GitHubリポジトリとコード・ドキュメントを同期します。

### 4.4. ハードウェアおよび仮想化環境の詳細

本 Bot の実行環境は、物理サーバー上に構築された仮想化プラットフォーム上で稼働しています。なのでDiscord Bot以外にもマイクラサーバーとかも追加で作れると思います。

#### 4.4.1. 仮想化プラットフォーム

Botは以下の2層構造の仮想化環境で稼働しています。

| 階層 | ソフトウェア/OS | 役割 |
| :--- | :--- | :--- |
| **物理ホストOS (Hypervisor)** | Proxmox VE 9.1 | 物理サーバー上で稼働し、仮想マシンを管理。高可用性（HA）とリソース管理を担当。 |
| **ゲストOS (VM)** | Ubuntu 24.04 LTS | Botの実行環境。Python、`discord.py`、`systemd` サービスがこのOS上で動作。 |

#### 4.4.2. 物理サーバー構成（自作PC）

Botが稼働する物理サーバーのハードウェア仕様は以下の通りです。

| 項目 | 詳細 | 備考 |
| :--- | :--- | :--- |
| **CPU** | Intel Core i3 9100F | 仮想マシンへリソースを割り当て。 |
| **RAM** | DDR4 16GB | 物理メモリ容量。ゲストOSへのメモリ割り当て上限の基準。 |
| **マザーボード** | Asrock H310CM-HDV/M.2 | |
| **ストレージ** | SSD 500GB | Proxmox VEのインストールと、ゲストOSのディスク領域として使用。 |

#### 4.4.3. 仮想マシン（Bot実行環境）へのリソース割り当て

物理リソースから Bot の実行環境であるゲストOSへ割り当てられているリソースは以下の通りです。このリソースは Proxmox VE の管理画面で確認されています。

| 項目 | 割り当て値 |
| :--- | :--- |
| **CPUコア数** | 1 CPU(s) |
| **メモリ** | 4.00 GiB (約 4GB) |
| **ブートディスク** | 32.00 GiB |
