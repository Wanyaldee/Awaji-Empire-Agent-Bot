# ⚙️ Awaji Empire Agent Bot - 詳細設計と運用ドキュメント

## 1. システム全体設計（データフロー）

本 Bot は、**「設定分離」「共通関数化」「機能のモジュール化（コグ）」**の3原則に基づいて設計されています。

| 要素 | 役割 | 連携先 | 備考 |
| :--- | :--- | :--- | :--- |
| **`config.py`** | チャンネルID、管理者IDなどの設定値定義。 | 全てのファイル。 | コードの再利用性と保守性を担保。 |
| **`bot.py` (Core)** | Discord接続、インテント管理、コグのロード。 | Discord API, 全てのコグ。 | コグが安全に利用できる `send_admin_dm` を提供。 |
| **`cogs/filter.py`** | メッセージ受信（`on_message`）フック。 | Discord API, `bot.py` (DM送信)。 | 不正投稿を検知し、即時削除とログ送信を実行。 |
| **`cogs/mass_mute.py`** | チャンネル作成フック、定時タスク。 | Discord API, `bot.py` (DM送信)。 | チャンネル権限（`@everyone`）を操作し、通知ミュートを適用。 |

## 2. コア機能の詳細設計

### 2.1. コグ間共通関数 (`bot.py` 内)

全てのコグが Bot の稼働状況やエラーを管理者に通知するために、以下の共通関数をコアで定義しています。

#### `async def send_admin_dm(bot, title, description, color)`

* **目的**: 管理者 (`config.ADMIN_USER_ID`) へログメッセージ（Embed形式）を送信。
* **処理**: `bot.fetch_user()` を使用してユーザーオブジェクトを取得し、DMを送信。

### 2.2. フィルタリング (`cogs/filter.py`)

#### 2.2.1. 監視ロジック

| 処理 | 詳細 |
| :--- | :--- |
| **トリガー** | `on_message` イベント。 |
| **除外条件** | 1. Bot自身のメッセージ。 2. `config.CODE_CHANNEL_ID` **ではない**チャンネルからのメッセージ。 3. `CODE_PATTERN` (8桁の英数字) に**完全に一致する**メッセージ。 |
| **アクション** | 除外条件に当てはまらない場合、`message.delete()` を実行し、`send_admin_dm` で削除ログを送信。 |

#### 2.2.2. エラー耐性

* `try...except discord.Forbidden`: Botにメッセージ削除権限がない場合でも、クラッシュを防ぎ、その旨を管理者にDMで通知します。

### 2.3. 通知マスミュート (`cogs/mass_mute.py`)

#### 2.3.1. 権限適用ロジック (`_apply_notification_mute_to_channel`)

* **適用対象**: チャンネルの `@everyone` ロール。
* **設定内容**: `overwrite.send_messages = False` （メッセージ送信を拒否）を設定し、通知ミュートを実現します。
* **DM通知**: **権限設定が実際に変更された場合のみ** (`return True` の場合)、`send_admin_dm` で成功ログを送信します。

#### 2.3.2. タスクとスケジューリング

| タスク | トリガー | 目的 |
| :--- | :--- | :--- |
| **`on_guild_channel_create`** | チャンネル作成イベント。 | `MUTE_CHANNEL_NAMES` に一致するチャンネルが作成された際、Botがすぐにミュートを適用し、ミュート適用漏れを防ぎます。 |
| **`daily_mute_check`** | 毎日 **16:00 JST**。 | 定期的に全ての対象チャンネルを巡回し、設定が何らかの理由で変更されていないかを確認し、再適用します。 |

## 3. 運用・デバッグ履歴（教訓）

### 3.1. ログの確認とエラーの種類

Botのログ（`systemd`）は、**標準出力（`print`）**と**標準エラー（例外）**の両方を含みます。

| エラー/現象 | 確認ログ | 意味 | 解決策 |
| :--- | :--- | :--- | :--- |
| **致命的クラッシュ** | `PrivilegedIntentsRequired` | **コードは正しい**が、Discordウェブサイトの権限設定が不足。 | Discord Developer Portalで3つのインテントを有効化。 |
| **機能不動作** | `TabError` や `SyntaxError` | **コードに不正なインデントまたは文字**が残存。 | `nano`などでファイルを開き、インデントをスペースに統一（今回は `mass_mute.py` で発生）。 |
| **定時タスク実行** | `🔔 定時ミュートチェックを開始` | タスクがスケジュール通りに起動したことを示します。 | DMが届かない場合は、まずこのログを確認する。 |

### 3.2. メンテナンストリビア

* **時刻管理**: `mass_mute.py` の定時タスクは、`datetime.time(tzinfo=JST)` を使用し、日本時間（JST, UTC+9）で正確に実行されるように設計されています。
* **トークンの扱い**: トークンは `token.txt` に保存され、`.gitignore` で厳重に管理されているため、GitHubへのプッシュ時も安全です。
